pipeline {
    agent {
        node {
            label 'docker-agent-node'
        }
    }

    environment {
        CI = 'true'
        REMOTE_USER = 'vriera-server'
        REMOTE_HOST = '186.139.150.69'
        REMOTE_PORT = '7022'
        REMOTE_DIRECTORY = '/home/vriera-server/redes/builds'
    }
    
    stages {
        stage('Fetch') {
            steps{ 
                echo "Fetching 💡"
                sh '''
                  yarn install --silent --frozen-lockfile
                '''
            } 
        }
        stage('Test') {
            steps { 
                echo "Testing ️🥊"
                sh '''
                yarn test
                '''
            }
        }
        stage('Build') {
            
            steps {
                // You can add your build steps here
                echo "Building 🛠️"
                sh '''
                yarn build
                '''
            }
        }
        stage('Deploy') {
            steps {
                input(message: 'Deploy to production?', ok: 'Deploy', submitter: 'admin')
                
                echo "Deploying 🚀"

                // Copy the build to the remote server
                sshagent(credentials: ['ssh-key']) {
                    sh 'scp -P $REMOTE_PORT -o StrictHostKeyChecking=no -r build/ $REMOTE_USER@$REMOTE_HOST:$REMOTE_DIRECTORY/$BUILD_ID'
                }

                // Deploy the build on the remote server
                sshagent(credentials: ['ssh-key']) {
                    sshCommand remote: "${env.REMOTE_USER}@${env.REMOTE_HOST}", port: env.REMOTE_PORT, 
                    command: "cd ${env.REMOTE_DIRECTORY} && ./deploy.sh"
                }
            }
        }
    }

    post {
      failure {
        echo "Build failed 😞"
        emailext body: "Build failed 😞", subject: "Build failed 😞", to: 'szavalia@itba.edu.ar'
      }
      success { 
        echo "Build succeeded 😊"
        emailext body: "Build succeeded 😊", subject: "Build succeeded 😊", to: 'szavalia@itba.edu.ar'
      }
    }
}